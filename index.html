<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Flip - Impara a Invertire le Formule</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Modal per inserimento nome -->
    <div class="name-modal" id="nameModal">
        <div class="name-content">
            <h2>üéÆ Benvenuto in Formula Flip! üéÆ</h2>
            <p>Inserisci il tuo nome per iniziare a giocare:</p>
            <input type="text" id="playerName" class="name-input" placeholder="Il tuo nome..." maxlength="20">
            <button class="start-btn" onclick="startGame()">üéÆ Inizia a Giocare</button>
        </div>
    </div>

    <!-- Modal per classifica -->
    <div class="leaderboard-modal" id="leaderboardModal">
        <div class="leaderboard-content">
            <h2>üèÜ Classifica in Tempo Reale üèÜ</h2>
            <table class="leaderboard-table" id="leaderboardTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Giocatore</th>
                        <th>üéØ Punteggio</th>
                        <th>üìà Livello</th>
                        <th>‚úÖ Corrette</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="5">Caricamento...</td></tr>
                </tbody>
            </table>
            <button class="reset-leaderboard-btn" onclick="resetLeaderboard()">üóëÔ∏è Reset Classifica</button>
            <button class="close-btn" onclick="closeLeaderboard()">Chiudi</button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-content">
            <h2>üì± Gioca da Smartphone!</h2>
            <p>Scansiona questo QR code per giocare da cellulare</p>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://rospoo.github.io/formule/" alt="QR Code" class="qr-image">
            <p><strong>URL:</strong> https://rospoo.github.io/formule/</p>
            <button class="close-btn" onclick="closeQR()">Chiudi</button>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="header">
            <h1>üéÆ Formula Flip üéÆ</h1>
            <div class="player-name-display" id="playerNameDisplay"></div>
            <button class="qr-button" onclick="showQR()">üì± QR Code</button>
            <button class="leaderboard-button" onclick="showLeaderboard()">üèÜ Classifica</button>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">LIVELLO</div>
                <div class="stat-value" id="level">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">PUNTEGGIO</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">CORRETTE</div>
                <div class="stat-value" id="correct">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">SBAGLIATE</div>
                <div class="stat-value" id="wrong">0</div>
            </div>
        </div>

        <div class="game-area">
            <div class="formula-section">
                <div class="formula-title">Inverti questa formula:</div>
                <div class="formula-display" id="formula">Caricamento...</div>
                <div class="target-variable">Trova: <span id="target">?</span></div>
                <div class="difficulty-indicator" id="difficulty">Difficolt√†: Facile</div>
            </div>

            <div class="answers-section">
                <button class="answer-btn" id="answer1">Caricamento...</button>
                <button class="answer-btn" id="answer2">Caricamento...</button>
                <button class="answer-btn" id="answer3">Caricamento...</button>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="next-btn">‚è≠Ô∏è Prossima Formula</button>
            <button class="btn reset" id="reset-btn">üîÑ Reset Gioco</button>
        </div>
    </div>

    <div class="feedback" id="feedback"></div>
    <div class="level-up" id="level-up">LIVELLO SUPERATO! üéâ</div>

    <script>
        // === CONFIGURAZIONE FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyAliez8fZ07_G6yoHjEPvxkVTr8WnvzSOY",
            authDomain: "formula-flip.firebaseapp.com",
            databaseURL: "https://formula-flip-default-rtdb.firebaseio.com",
            projectId: "formula-flip",
            storageBucket: "formula-flip.firebasestorage.app",
            messagingSenderId: "861458789852",
            appId: "1:861458789852:web:9a55d30515399c111acb19"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ROOM_NAME = "CLASSE_3A";

        // STATISTICHE DI GIOCO
        let gameStats = {
            level: 1,
            score: 0,
            correct: 0,
            wrong: 0,
            streak: 0,
            maxStreak: 0,
            playerName: ''
        };

        // ... [tutto il codice delle funzioni di generazione formule rimane identico] ...

        // CONFIGURAZIONE LIVELLI
        const levelConfig = {
            1: { difficulty: 'facile', patterns: ['simpleMul', 'simpleDiv', 'simpleAdd'], maxDepth: 1 },
            2: { difficulty: 'facile', patterns: ['twoOps', 'simpleParen'], maxDepth: 2 },
            3: { difficulty: 'media', patterns: ['twoOpsWithParen', 'divWithParen'], maxDepth: 2 },
            4: { difficulty: 'media', patterns: ['complexTwoOps', 'divWithParen'], maxDepth: 3 },
            5: { difficulty: 'difficile', patterns: ['complexParen', 'complexDiv'], maxDepth: 3 },
            6: { difficulty: 'difficile', patterns: ['complexMultiOps', 'complexParen'], maxDepth: 4 },
            7: { difficulty: 'esperto', patterns: ['complexMultiOps', 'complexDiv'], maxDepth: 4 },
            8: { difficulty: 'esperto', patterns: ['complexNested', 'complexMultiOps'], maxDepth: 5 }
        };

        const variables = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'M', 'R', 'K', 'P', 'Q', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        const numericConstants = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20, 23, 25, 30, 40, 50, 56, 100];

        class UniqueVariableGenerator {
            constructor() { this.reset(); }
            reset() { this.usedVariables = new Set(); this.index = 0; }
            getNextVariable() {
                while (this.index < variables.length) {
                    const varName = variables[this.index];
                    if (!this.usedVariables.has(varName)) {
                        this.usedVariables.add(varName);
                        this.index++;
                        return varName;
                    }
                    this.index++;
                }
                this.reset();
                return this.getNextVariable();
            }
        }

        // === FUNZIONI GENERAZIONE FORMULE ===
        function generateSimpleMultiplication() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            return { formula: `${A}*${B}=${C}`, correctAnswer: `${C}/${A}`, target: B };
        }

        function generateSimpleDivision() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            return { formula: `${A}/${B}=${C}`, correctAnswer: `${A}/${C}`, target: B };
        }

        function generateSimpleAddition() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            return { formula: `${A}+${B}=${C}`, correctAnswer: `${C}-${A}`, target: B };
        }

        function generateTwoOperations() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            return { formula: `${A}*${B}+${C}=${D}`, correctAnswer: `(${D}-${C})/${A}`, target: B };
        }

        function generateSimpleParentheses() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            return { formula: `${A}*(${B}+${C})=${D}`, correctAnswer: `(${D}/${A})-${C}`, target: B };
        }

        function generateTwoOperationsWithParentheses() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            const E = varGen.getNextVariable();
            return { formula: `${A}*${B}+${C}/${D}=${E}`, correctAnswer: `(${E}-${C}/${D})/${A}`, target: B };
        }

        function generateDivisionWithParentheses() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            return { formula: `${A}/(${B}+${C})=${D}`, correctAnswer: `(${A}/${D})-${C}`, target: B };
        }

        function generateComplexTwoOperations() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            const E = varGen.getNextVariable();
            return { formula: `${A}*${B}+${C}*${D}=${E}`, correctAnswer: `(${E}-${C}*${D})/${A}`, target: B };
        }

        function generateComplexParentheses() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            const E = varGen.getNextVariable();
            return { formula: `${A}*(${B}+${C}*${D})=${E}`, correctAnswer: `(${E}/${A})-${C}*${D}`, target: B };
        }

        function generateComplexDivision() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            const E = varGen.getNextVariable();
            return { formula: `${A}/(${B}+${C})=${D}/${E}`, correctAnswer: `(${A}*${E}/${D})-${C}`, target: B };
        }

        function generateComplexMultiOperations() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            const E = varGen.getNextVariable();
            const F = varGen.getNextVariable();
            return { formula: `${A}*${B}+${C}/${D}-${E}=${F}`, correctAnswer: `(${F}+${E}-${C}/${D})/${A}`, target: B };
        }

        function generateComplexNested() {
            const varGen = new UniqueVariableGenerator();
            const A = varGen.getNextVariable();
            const B = varGen.getNextVariable();
            const C = varGen.getNextVariable();
            const D = varGen.getNextVariable();
            const E = varGen.getNextVariable();
            const F = varGen.getNextVariable();
            return { formula: `${A}*(${B}+${C}/(${D}+${E}))=${F}`, correctAnswer: `(${F}/${A})-${C}/(${D}+${E})`, target: B };
        }

        const patternFunctions = {
            'simpleMul': generateSimpleMultiplication,
            'simpleDiv': generateSimpleDivision,
            'simpleAdd': generateSimpleAddition,
            'twoOps': generateTwoOperations,
            'simpleParen': generateSimpleParentheses,
            'twoOpsWithParen': generateTwoOperationsWithParentheses,
            'divWithParen': generateDivisionWithParentheses,
            'complexTwoOps': generateComplexTwoOperations,
            'complexParen': generateComplexParentheses,
            'complexDiv': generateComplexDivision,
            'complexMultiOps': generateComplexMultiOperations,
            'complexNested': generateComplexNested
        };

        function getRandomConstant() {
            return numericConstants[Math.floor(Math.random() * numericConstants.length)];
        }

        function generateRandomFormula(level) {
            const config = levelConfig[Math.min(level, 8)];
            const patterns = config.patterns;
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            return patternFunctions[pattern]();
        }

        function generateWrongAnswers(correctAnswer, target, formula) {
            const candidates = [
                correctAnswer.replace(/\//g, '*').replace(/\*/g, '/').replace(/\+/g, '-').replace(/-/g, '+'),
                correctAnswer.replace(/\(/g, '').replace(/\)/g, ''),
                `(${correctAnswer})+${getRandomConstant()}`,
                correctAnswer.replace(/([A-Z])/g, match => {
                    const idx = variables.indexOf(match);
                    return idx >= 0 && idx < variables.length - 1 ? variables[idx + 1] : match;
                }),
                correctAnswer.includes('/') ? correctAnswer.split('/').reverse().join('/') : `${correctAnswer}*${getRandomConstant()}`,
                `(${correctAnswer})`
            ];

            const filtered = candidates.filter(ans => ans !== correctAnswer && ans.length < 100 && ans.trim() !== '');
            while (filtered.length < 2) filtered.push(`(${correctAnswer})+${getRandomConstant()}`);
            return [...new Set(filtered)].slice(0, 2);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // === FUNZIONI FIREBASE AGGIORNATE ===
        function saveScoreToFirebase() {
            if (!gameStats.playerName) return;
            db.ref(`rooms/${ROOM_NAME}/players/${gameStats.playerName}`).set({
                score: gameStats.score,
                level: gameStats.level,
                correct: gameStats.correct,
                wrong: gameStats.wrong,
                lastUpdate: Date.now()
            });
        }

        function listenToLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            db.ref(`rooms/${ROOM_NAME}/players`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="5">Nessun giocatore ancora</td></tr>';
                    return;
                }

                const players = Object.entries(data)
                    .map(([name, stats]) => ({ name, ...stats }))
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 25); // ‚úÖ Mostra almeno 25 nomi

                tbody.innerHTML = players.map((p, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${p.name}</td>
                        <td>${p.score}</td>
                        <td>${p.level}</td>
                        <td>${p.correct}</td>
                    </tr>
                `).join('');
            });
        }

        function resetLeaderboard() {
            if (confirm("Sei sicuro di voler resettare la classifica?")) {
                db.ref(`rooms/${ROOM_NAME}/players`).remove();
            }
        }

        // === LOGICA DI GIOCO (identica) ===
        let currentFormula = '';
        let currentTarget = '';
        let currentCorrectAnswer = '';
        let currentAnswers = [];

        function updateStats() {
            document.getElementById('level').textContent = gameStats.level;
            document.getElementById('score').textContent = gameStats.score;
            document.getElementById('correct').textContent = gameStats.correct;
            document.getElementById('wrong').textContent = gameStats.wrong;
            document.getElementById('playerNameDisplay').textContent = gameStats.playerName;

            const difficultyNames = { 'facile': 'Facile üü¢', 'media': 'Media üü°', 'difficile': 'Difficile üî¥', 'esperto': 'Esperto ‚ö´' };
            const config = levelConfig[Math.min(gameStats.level, 8)];
            document.getElementById('difficulty').textContent = `Difficolt√†: ${difficultyNames[config.difficulty]}`;
        }

        function showFeedback(isCorrect) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = isCorrect ? '‚úÖ CORRETTO!' : '‚ùå SBAGLIATO!';
            feedback.className = `feedback ${isCorrect ? 'correct' : 'wrong'}`;
            feedback.style.opacity = '1';
            setTimeout(() => { feedback.style.opacity = '0'; }, 1500);
        }

        function showLevelUp() {
            const levelUp = document.getElementById('level-up');
            levelUp.textContent = `LIVELLO ${gameStats.level} SUPERATO! üéâ`;
            levelUp.style.opacity = '1';
            setTimeout(() => { levelUp.style.opacity = '0'; }, 2000);
        }

        function generateNewFormula() {
            const formulaData = generateRandomFormula(gameStats.level);
            currentFormula = formulaData.formula;
            currentTarget = formulaData.target;
            currentCorrectAnswer = formulaData.correctAnswer;

            document.getElementById('formula').textContent = currentFormula;
            document.getElementById('target').textContent = currentTarget;

            const wrongAnswers = generateWrongAnswers(currentCorrectAnswer, currentTarget, currentFormula);
            const allAnswers = [currentCorrectAnswer, ...wrongAnswers, ...wrongAnswers.slice(0, 1)].slice(0, 3);
            shuffleArray(allAnswers);
            currentAnswers = allAnswers;

            const answerButtons = [
                document.getElementById('answer1'),
                document.getElementById('answer2'),
                document.getElementById('answer3')
            ];
            answerButtons.forEach((btn, i) => {
                btn.textContent = currentAnswers[i];
                btn.className = 'answer-btn';
                btn.onclick = () => checkAnswer(i);
                btn.disabled = false;
            });
        }

        function checkAnswer(index) {
            const isCorrect = currentAnswers[index] === currentCorrectAnswer;
            const answerButtons = [
                document.getElementById('answer1'),
                document.getElementById('answer2'),
                document.getElementById('answer3')
            ];

            answerButtons.forEach((btn, i) => {
                btn.disabled = true;
                if (currentAnswers[i] === currentCorrectAnswer) btn.className = 'answer-btn correct';
                else if (i === index && !isCorrect) btn.className = 'answer-btn wrong';
            });

            showFeedback(isCorrect);

            if (isCorrect) {
                gameStats.correct++;
                gameStats.streak++;
                gameStats.maxStreak = Math.max(gameStats.maxStreak, gameStats.streak);
                let points = 10;
                if (gameStats.streak >= 3) points += 5;
                if (gameStats.streak >= 5) points += 5;
                gameStats.score += points;
                if (gameStats.correct % 5 === 0 && gameStats.level < 8) {
                    gameStats.level++;
                    showLevelUp();
                }
            } else {
                gameStats.wrong++;
                gameStats.streak = 0;
            }

            updateStats();
            saveScoreToFirebase();
        }

        function resetGame() {
            gameStats = {
                level: 1,
                score: 0,
                correct: 0,
                wrong: 0,
                streak: 0,
                maxStreak: 0,
                playerName: gameStats.playerName
            };
            updateStats();
            generateNewFormula();
        }

        // === MODAL AGGIORNATI ===
        function startGame() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) { alert('Inserisci il tuo nome!'); return; }
            gameStats.playerName = name;
            document.getElementById('nameModal').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            updateStats();
            generateNewFormula();
        }

        let leaderboardInterval = null;

        function showLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'flex';
            listenToLeaderboard(); // primo caricamento

            // ‚úÖ Aggiorna ogni 5 secondi
            if (leaderboardInterval) clearInterval(leaderboardInterval);
            leaderboardInterval = setInterval(() => {
                listenToLeaderboard();
            }, 5000);
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'none';
            if (leaderboardInterval) {
                clearInterval(leaderboardInterval);
                leaderboardInterval = null;
            }
        }

        function showQR() {
            document.getElementById('qrModal').style.display = 'flex';
        }

        function closeQR() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // === INIZIALIZZAZIONE ===
        document.getElementById('next-btn').onclick = generateNewFormula;
        document.getElementById('reset-btn').onclick = resetGame;

        if (navigator.platform.includes('Mac')) {
            document.documentElement.style.height = '100vh';
            document.body.style.height = '100vh';
        }
    </script>
</body>
</html>
